<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Order Pad</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:16px; max-width:1050px}
    h1{font-size:20px; margin:0 0 10px}
    h2{font-size:16px; margin:18px 0 8px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    select, textarea, button, input{font-size:16px}
    .cat{margin:16px 0 6px; font-weight:700}
    .grid{display:grid; grid-template-columns:1fr; gap:8px}
    .item{border:1px solid #ddd; border-radius:10px; padding:10px; display:flex; justify-content:space-between; gap:10px; align-items:center}
    .name{font-weight:600}
    .qty{display:flex; gap:8px; align-items:center}
    .qty button{width:44px; height:40px}
    .qty span{min-width:26px; text-align:center; font-weight:700}
    .panel{border:1px solid #ddd; border-radius:10px; padding:10px; margin-top:14px}
    pre{white-space:pre-wrap; word-break:break-word; background:#f7f7f7; padding:10px; border-radius:10px; margin:10px 0 0}
    .cart{position:sticky; bottom:0; background:#fff; border-top:2px solid #000; padding:10px 0; margin-top:18px; z-index:50}
    .danger{color:#b00020}
    .ok{color:#0b6b0b}
    .small{font-size:13px; opacity:.85}
    .tabs{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
    .tabBtn{padding:8px 12px; border:1px solid #aaa; border-radius:999px; background:#fff}
    .tabBtn.active{border:2px solid #000; font-weight:700}
    .orders{display:grid; grid-template-columns:1fr; gap:10px}
    .ticket{border:1px solid #ddd; border-radius:10px; padding:10px; position:relative}
    .ticket .top{display:flex; justify-content:space-between; gap:10px; align-items:baseline}
    .ticket .top b{font-size:16px}
    .muted{opacity:.75}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; align-items:center}

    /* cart lines */
    .cartLine{border:1px solid #ddd; border-radius:10px; padding:10px; margin-top:10px}
    .cartLineTop{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .cartLineName{font-weight:700}
    .cartLineBtns{display:flex; gap:8px; align-items:center}
    .cartLineBtns button{width:44px; height:40px}
    .noteBox{width:100%; margin-top:8px}
    .noteBox textarea{width:100%; font-size:15px}

    /* cart list container: collapsible */
    .cartListWrap{
      border-top:1px dashed #bbb;
      margin-top:10px;
      padding-top:10px;
      overflow:auto;
      max-height: 130px; /* ~1.3 items */
    }
    .cartListWrap.expanded{
      max-height: 67vh;  /* expanded target */
    }

    /* top navigation */
    .topNav{
      display:flex;
      gap:10px;
      flex-wrap:nowrap;
      margin-bottom:12px;
      position:sticky;
      top:0;
      background:#fff;
      padding:10px 0;
      z-index:100;
      border-bottom:1px solid #eee;
    }
    .topNav .tabBtn{
    flex: 1 1 0;
    width: auto;          /* remove forced 50% */
    min-width: 0;         /* allow shrink */
    justify-content: center;
    }

    /* modal */
    .modalBack{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:16px; z-index:9999}
    .modal{background:#fff; border-radius:14px; padding:14px; max-width:560px; width:100%; border:1px solid #ddd}
    .modal h3{margin:0 0 10px; font-size:18px}
    .modal .btnGrid{display:flex; flex-wrap:wrap; gap:10px}
    .modal button{padding:10px 12px; border-radius:12px; border:1px solid #aaa; background:#fff}
    .modal button.primary{border:2px solid #000; font-weight:700}
    .modal .field{margin-top:10px}
    .modal label{display:block; font-size:13px; opacity:.85; margin-bottom:4px}
    .modal select{width:100%; padding:10px; border-radius:10px; border:1px solid #aaa}
    .modal .rowEnd{display:flex; justify-content:flex-end; gap:10px; margin-top:12px}

    html, body { touch-action: manipulation; }

    .expandBtn{
      width:44px;
      height:40px;
      border:1px solid #aaa;
      border-radius:12px;
      background:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0;
    }
    .expandBtn svg{ width:24px; height:24px; }

    /* ORDER UI tweaks */
    #tableSel{ padding:10px 12px; height:46px; border-radius:12px; border:1px solid #aaa; }
    #catSel{ padding:10px 12px; height:46px; border-radius:12px; border:1px solid #aaa; }
    #searchBox{ padding:10px 12px; height:46px; border-radius:12px; border:1px solid #aaa; flex:1 1 220px; width:100%; padding-right:44px; }
    .nameBtn{
      width:100%;
      text-align:left;
      padding:12px 12px;
      border:1px solid #aaa;
      border-radius:12px;
      background:#fff;
      font-weight:600;
      cursor:pointer;
    }
    .nameBtn:active{ transform: translateY(1px); }

    /* search clear X */
    .searchWrap{ position:relative; flex:1 1 220px; }
    .clearSearchBtn{
      position:absolute;
      right:8px;
      top:50%;
      transform:translateY(-50%);
      width:34px;
      height:34px;
      border:1px solid #aaa;
      border-radius:10px;
      background:#fff;
      display:none;
      align-items:center;
      justify-content:center;
      font-size:20px;
      line-height:1;
      padding:0;
    }

    /* ORDERED UI tweaks */
    .orderSepLine{ color:#666; } /* used inside <pre> */
    .kebabBtn{
      position:absolute;
      right:10px;
      bottom:10px;
      width:38px;
      height:34px;
      border:1px solid #aaa;
      border-radius:10px;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
    }
    .kebabDots{ display:flex; gap:4px; align-items:center; justify-content:center; }
    .kebabDots span{ width:4px; height:4px; border-radius:999px; background:#111; display:inline-block; opacity:.85; }

    .kebabMenu{
      position:absolute;
      right:10px;
      bottom:52px;
      border:1px solid #aaa;
      border-radius:12px;
      background:#fff;
      overflow:hidden;
      display:none;
      min-width:150px;
      z-index:10;
    }
    .kebabMenu button{
      width:100%;
      text-align:left;
      padding:10px 12px;
      border:0;
      border-bottom:1px solid #eee;
      background:#fff;
      font-size:15px;
    }
    .kebabMenu button:last-child{ border-bottom:0; }
    .kebabMenu button.dangerBtn{ color:#b00020; }

    /* SEND overlay */
    .sendOverlay{
      position:fixed;
      inset:0;
      background:rgba(255,255,255,.92);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99999;
      padding:16px;
      text-align:center;
    }
    .sendOverlay .box{
      max-width:520px;
      width:100%;
      border:1px solid #ddd;
      border-radius:16px;
      padding:16px;
      background:#fff;
    }
    .sendOverlay .title{ font-size:20px; font-weight:800; }
    .sendOverlay .msg{ margin-top:10px; font-size:15px; opacity:.85; }
    .sendOverlay .close{
      margin-top:14px;
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid #aaa;
      background:#fff;
      display:none;
    }

/* disable sticky header/footer: make them scroll normally */
.topNav{
  position: static !important;
  top: auto !important;
}

.cart{
  position: static !important;
  bottom: auto !important;
}
 


  </style>
</head>
<body>

  <!-- Main navigation -->
  <div class="topNav">
    <button id="navOrder" class="tabBtn active" type="button">Order</button>
    <button id="navOrdered" class="tabBtn" type="button">Ordered</button>
  </div>

  <!-- PAGE: ORDER -->
  <div id="pageOrder">
    <h1>Upstairs Ordering (Temporary)</h1>

    <div class="row">
      <label>Table:</label>
      <select id="tableSel"></select>

      <!-- removed "Category:" text label, keep function -->
      <select id="catSel"></select>

      <!-- search with clear X -->
      <div class="searchWrap">
        <input id="searchBox" type="text" placeholder="Search items..." inputmode="search" />
        <button id="clearSearchBtn" class="clearSearchBtn" type="button" aria-label="Clear search">×</button>
      </div>

      <!-- Clear Current button REMOVED -->
    </div>

    <div id="itemsWrap"></div>

    <!-- Overview / fallback -->
    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <div><b>Overview (Fallback)</b> <span class="muted">— copy text or screenshot</span></div>
        <div class="row">
          <button id="copyBtn" type="button">Copy Text</button>
          <button id="fullscreenBtn" type="button">Fullscreen</button>
        </div>
      </div>
      <pre id="overviewBox"></pre>
    </div>

    <!-- Cart -->
    <div class="cart">
      <div class="row" style="justify-content:space-between;">
        <div><b>Total items:</b> <span id="totalQty">0</span></div>
        <div class="row">
          <button id="expandBtn" class="expandBtn" type="button" aria-label="Expand cart"></button>
          <button id="submitBtn" type="button">Send Order</button>
        </div>
      </div>
      <div id="status" class="danger" style="margin-top:6px;"></div>

      <div id="cartListWrap" class="cartListWrap">
        <div id="cartLines"></div>
      </div>
    </div>
  </div>

  <!-- PAGE: ORDERED -->
  <div id="pageOrdered" style="display:none;">
    <h2>Ordered</h2>

    <!-- Sub navigation: New / Keyed In -->
    <div class="tabs">
      <button id="tabNew" class="tabBtn active" type="button">New</button>
      <button id="tabKeyed" class="tabBtn" type="button">Keyed In</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="refreshBtn" type="button">Refresh Now</button>
      <span id="liveStatus" class="small"></span>
    </div>

    <div id="ordersWrap" class="orders" style="margin-top:10px;"></div>

    <!-- End of day -->
    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <div><b>End of Day</b> <span class="muted">— clears ALL records</span></div>
        <button id="clearAllBtn" type="button">Clear All Records</button>
      </div>
      <div class="small">This requires a secret key. Use only when closing.</div>
    </div>
  </div>

  <!-- modal -->
  <div id="modalBack" class="modalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle">Select</h3>
      <div id="modalBody"></div>
      <div class="rowEnd">
        <button id="modalCancel" type="button">Cancel</button>
        <button id="modalOk" class="primary" type="button">OK</button>
      </div>
    </div>
  </div>

  <!-- SEND overlay -->
  <div id="sendOverlay" class="sendOverlay">
    <div class="box">
      <div id="sendOverlayTitle" class="title">Sending…</div>
      <div id="sendOverlayMsg" class="msg">Please wait.</div>
      <button id="sendOverlayClose" class="close" type="button">Close</button>
    </div>
  </div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxzxwszj6lmX27GgSahiFcCTaH9bWQle7ovY3LNtUfTkV6wkY97EBaVZ3rSiDh8FDAX/exec";

  function mustHaveUrl_(){
    return typeof SCRIPT_URL === "string"
      && SCRIPT_URL.startsWith("https://script.google.com/macros/")
      && SCRIPT_URL.endsWith("/exec");
  }

  // ---- FOOD MENU ----
  const FOOD_MENU = {
    "Starters": [
      "Homemade Pandan Fried Chicken","Roti Prata","Penang Style Grilled Tofu","House Combo Bento",
      "Veggie House Combo","House Special Deep Fried Skewer Set","Crispy Duck (1/4)","Crispy Duck (1/2)",
      "Grilled Chicken Satay Skewers","Spring Roll (Veg)","Spring Roll (Meat)","Five-Spice Fried Roll",
      "Gyoza (Chicken)","Gyoza (Veg)","Salt & Pepper Chicken"
    ],
    "Malaysian Curries": [
      "Rendang Beef Brisket","Malaysian Chicken Curry",
      "Asam Curry (Chicken)","Asam Curry (Beef)","Asam Curry (Tofu)","Asam Curry (Prawn)",
      "Nyonya Gulai Curry (Chicken)","Nyonya Gulai Curry (Beef)","Nyonya Gulai Curry (Tofu)","Nyonya Gulai Curry (Prawn)",
      "Red Curry (Chicken)","Red Curry (Beef)","Red Curry (Tofu)","Red Curry (Prawn)"
    ],
    "Noodles": [
      "Malaysian Curry Laksa (Chicken)","Malaysian Curry Laksa (Prawn)","Malay-Style Special Noodles",
      "Malaysian Style Char Kuey Teow","Rojak Mee","Pad Malay","Wat Tan Hor Fun"
    ],
    "Asian Favourites": [
      "Creamy Salted Egg (Crispy Chicken)","Creamy Salted Egg (King Prawn)",
      "Kung Po (Beef)","Kung Po (Chicken)","Kung Po (King Prawn)",
      "Black Pepper (Beef)","Black Pepper (Chicken)","Black Pepper (King Prawn)",
      "Szechuan (Beef)","Szechuan (Chicken)","Szechuan (King Prawn)",
      "Sambal Stir-Fried Morning Glory","Garlic Stir-Fried Morning Glory"
    ],
    "Asian Salads": ["Acar Salad","Rojak Salad"],
    "Sizzling Platters": ["Sambal Sizzling King Prawn","Sizzling Black Pepper Beef Tenderloin"],
    "Rice Dishes": [
      "Nasi Lemak (Fried Chicken)","Nasi Lemak (Beef Brisket)","Nasi Goreng Sambal Fried Rice",
      "Hainanese Chicken Rice","Pineapple Fried Rice","Vegetable Fried Rice"
    ],
    "Sides": ["Coconut Rice","Fragrant Rice","Boiled Rice","Egg Fried Rice","Noodles","Chips"],
    "Dessert": ["Banana Fritter"]
  };

  // ---- DRINKS MENU ----
  const MIXER_CHOICES = ["Lemonade","Coke","Diet Coke","Tonic","Slimline Tonic","Fruit Juice"];
  const DRINKS_MENU = {
    "Drinks — White Wine": [
      { type:"wine", name:"Cuvée Duboeuf Blanc (Bouquet Label)", sizes:[ {label:"Bottle", price:27.95} ] },
      { type:"wine", name:"Pinot Grigio delle Dolomiti (Trovati)", sizes:[ {label:"125ml", price:5.50},{label:"175ml", price:7.50},{label:"Bottle", price:28.95} ] },
      { type:"wine", name:"Fiddlehead Sauvignon Blanc", sizes:[ {label:"125ml", price:5.75},{label:"175ml", price:7.95},{label:"Bottle", price:29.95} ] },
      { type:"wine", name:"Sancerre (Domaine Cherrier)", sizes:[ {label:"Bottle", price:49.95} ] },
      { type:"wine", name:"Chablis 1er Cru (Vau de Vey, Brocard Organic)", sizes:[ {label:"Bottle", price:69.95} ] }
    ],
    "Drinks — Rosé Wine": [
      { type:"wine", name:"Zinfandel Rosé (Beringer)", sizes:[ {label:"125ml", price:5.25},{label:"175ml", price:6.95},{label:"Bottle", price:27.95} ] },
      { type:"wine", name:"Lady A (La Coste Provence Rosé)", sizes:[ {label:"Bottle", price:39.95} ] }
    ],
    "Drinks — Red Wine": [
      { type:"wine", name:"Cuvée Duboeuf Rouge (Bouquet Label)", sizes:[ {label:"Bottle", price:27.95} ] },
      { type:"wine", name:"Merlot Reserva (Poco Mas)", sizes:[ {label:"125ml", price:5.50},{label:"175ml", price:7.50},{label:"Bottle", price:28.95} ] },
      { type:"wine", name:"Malbec Porteño (Norton)", sizes:[ {label:"125ml", price:5.75},{label:"175ml", price:7.95},{label:"Bottle", price:29.95} ] },
      { type:"wine", name:"Rioja Reserva (Conde Valdemar)", sizes:[ {label:"Bottle", price:44.95} ] },
      { type:"wine", name:"Château Chantalouette (Pomerol)", sizes:[ {label:"Bottle", price:79.95} ] }
    ],
    "Drinks — The Fizz": [
      { type:"wine", name:"Prosecco Extra Dry (Serena 1881)", sizes:[ {label:"Mini bottle", price:8.95} ] },
      { type:"wine", name:"Cá del Console Prosecco Extra Dry", sizes:[ {label:"Bottle", price:29.95} ] },
      { type:"wine", name:"Organic Prosecco (Serena 1881)", sizes:[ {label:"Bottle", price:35.00} ] },
      { type:"wine", name:"Champagne Laurent-Perrier La Cuvée", sizes:[ {label:"Bottle", price:79.95} ] }
    ],
    "Drinks — Mocktails": [
      { type:"plain", name:"Galaxy Strawberry", price:5.90 },
      { type:"plain", name:"Lemon Yakult", price:5.90 },
      { type:"plain", name:"Passionfruit Green Tea", price:5.90 }
    ],
    "Drinks — Cocktails": [
      { type:"plain", name:"Strawberry Jupiter", price:9.90 },
      { type:"plain", name:"Oriental Blue Moon", price:9.90 }
    ],
    "Drinks — Signature Drinks": [
      { type:"plain", name:"White Coffee Iced", price:3.95 },
      { type:"plain", name:"Syrup Bandung", price:3.95 },
      { type:"plain", name:"Milo Iced", price:3.95 }
    ],
    "Drinks — Beer": [
      { type:"plain", name:"Tsing Tao Beer", price:4.90 },
      { type:"plain", name:"Tiger Beer", price:4.90 },
      { type:"plain", name:"Asahi Beer", price:4.90 }
    ],
    "Drinks — Spirits (per shot)": [
      { type:"spirit", name:"Gin", basePrice:3.60 },
      { type:"spirit", name:"Vodka", basePrice:3.60 },
      { type:"spirit", name:"Tequila", basePrice:3.60 },
      { type:"spirit", name:"Whisky", basePrice:4.10 },
      { type:"spirit", name:"Brandy", basePrice:4.10 },
      { type:"spirit", name:"Hennessy XO Brandy", basePrice:18.00 },
      { type:"spirit", name:"Tequila Rose", basePrice:4.00 },
      { type:"spirit", name:"Cazcabel Honey", basePrice:4.00 }
    ],
    "Drinks — Soft Drinks": [
      { type:"plain", name:"J2O Orange & Passionfruit", price:3.00 },
      { type:"plain", name:"Coke", price:3.00 },
      { type:"plain", name:"Diet Coke", price:3.00 },
      { type:"plain", name:"Lemonade", price:3.00 },
      { type:"plain", name:"Tonic", price:3.00 },
      { type:"plain", name:"Slimline Tonic", price:3.00 },
      { type:"plain", name:"Fruit Juice", price:3.00 },
      { type:"plain", name:"Aloe Vera Juice", price:3.50 },
      { type:"plain", name:"Coconut Juice", price:3.50 },
      { type:"plain", name:"Still Water", price:2.50 },
      { type:"plain", name:"Sparkling Water", price:2.50 }
    ],
    "Drinks — Hot Drinks": [
      { type:"plain", name:"Chinese Tea", price:2.50 },
      { type:"plain", name:"English Tea", price:3.00 },
      { type:"plain", name:"Coffee", price:3.00 }
    ]
  };

  const MENU = { ...FOOD_MENU, ...DRINKS_MENU };

  const state = {
    page: "ORDER",
    table: "1",
    cat: Object.keys(MENU)[0],
    cartLines: [],
    orderedTab: "NEW",
    cartExpanded: false,
    search: ""
  };

  const navOrderBtn = document.getElementById('navOrder');
  const navOrderedBtn = document.getElementById('navOrdered');
  const pageOrder = document.getElementById('pageOrder');
  const pageOrdered = document.getElementById('pageOrdered');

  const tableSel = document.getElementById('tableSel');
  const catSel = document.getElementById('catSel');
  const searchBox = document.getElementById('searchBox');
  const clearSearchBtn = document.getElementById('clearSearchBtn');

  const itemsWrap = document.getElementById('itemsWrap');
  const totalQtyEl = document.getElementById('totalQty');
  const statusEl = document.getElementById('status');
  const overviewBox = document.getElementById('overviewBox');
  const cartLinesEl = document.getElementById('cartLines');
  const cartListWrap = document.getElementById('cartListWrap');
  const expandBtn = document.getElementById('expandBtn');

  const ordersWrap = document.getElementById('ordersWrap');
  const liveStatus = document.getElementById('liveStatus');
  const tabNewBtn = document.getElementById('tabNew');
  const tabKeyedBtn = document.getElementById('tabKeyed');

  // modal
  const modalBack = document.getElementById('modalBack');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const modalCancel = document.getElementById('modalCancel');
  const modalOk = document.getElementById('modalOk');

  // send overlay
  const sendOverlay = document.getElementById('sendOverlay');
  const sendOverlayTitle = document.getElementById('sendOverlayTitle');
  const sendOverlayMsg = document.getElementById('sendOverlayMsg');
  const sendOverlayClose = document.getElementById('sendOverlayClose');

  function showSendOverlay_(title, msg, closable){
    sendOverlayTitle.textContent = title || "";
    sendOverlayMsg.textContent = msg || "";
    sendOverlay.style.display = "flex";
    sendOverlayClose.style.display = closable ? "block" : "none";
  }
  function hideSendOverlay_(){ sendOverlay.style.display = "none"; }
  sendOverlayClose.onclick = hideSendOverlay_;

  function uid_(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

  function openModal_(title, renderFn){
    return new Promise((resolve) => {
      modalTitle.textContent = title;
      modalBody.innerHTML = "";
      const api = renderFn(modalBody);

      function close(val){
        modalBack.style.display = "none";
        modalCancel.onclick = null;
        modalOk.onclick = null;
        resolve(val);
      }

      modalBack.style.display = "flex";
      modalCancel.onclick = () => close(null);
      modalOk.onclick = () => close(api.get());
    });
  }

  function setPage_(p){
  state.page = p;
  navOrderBtn.classList.toggle("active", p==="ORDER");
  navOrderedBtn.classList.toggle("active", p==="ORDERED");
  pageOrder.style.display = (p==="ORDER") ? "" : "none";
  pageOrdered.style.display = (p==="ORDERED") ? "" : "none";

  if (p==="ORDERED") {
    liveStatus.textContent = "Refreshing…";
    fetchOrders({ force:true }); // 只有用戶切頁先 force
  }
}


  navOrderBtn.onclick = ()=>setPage_("ORDER");
  navOrderedBtn.onclick = ()=>setPage_("ORDERED");

  // Tables 1..33 (display without "T")
  for (let i=1;i<=33;i++){
    const o=document.createElement('option');
    o.value=String(i);
    o.textContent=String(i);
    tableSel.appendChild(o);
  }
  tableSel.value = state.table;
  tableSel.onchange=()=>{state.table=tableSel.value; renderOverview();};

  // Categories
  Object.keys(MENU).forEach(c=>{
    const o=document.createElement('option');
    o.value=c; o.textContent=c;
    catSel.appendChild(o);
  });
  catSel.value = state.cat;
  catSel.onchange=()=>{state.cat=catSel.value; renderItems();};

  // Search with clear X
  function syncClearSearchBtn_(){
    const has = String(searchBox.value || "").length > 0;
    clearSearchBtn.style.display = has ? "inline-flex" : "none";
  }
  searchBox.oninput = ()=>{
    state.search = String(searchBox.value || "").trim();
    syncClearSearchBtn_();
    renderItems();
  };
  clearSearchBtn.onclick = ()=>{
    searchBox.value = "";
    state.search = "";
    syncClearSearchBtn_();
    renderItems();
    searchBox.focus();
  };
  syncClearSearchBtn_();

  function totalQty_(){ return state.cartLines.reduce((s,l)=> s + (Number(l.qty)||0), 0); }
  function countBase_(baseName){ return state.cartLines.reduce((s,l)=> s + (l.baseName===baseName ? l.qty : 0), 0); }

  function addLine_(line){
    state.cartLines.push(line);
    renderAll();
    setTimeout(scrollCartToBottom_, 0); /* auto-scroll to bottom on add */
  }

  function removeOne_(baseName){
    for (let i = state.cartLines.length - 1; i >= 0; i--){
      const l = state.cartLines[i];
      if (l.baseName === baseName){
        if (l.qty > 1) l.qty -= 1;
        else state.cartLines.splice(i,1);
        break;
      }
    }
    renderAll();
  }

  function findItemByName_(name){
    for (const cat of Object.keys(MENU)){
      const arr = MENU[cat] || [];
      for (const it of arr){
        if (typeof it === "string"){
          if (it === name) return it;
        } else if (it && it.name === name){
          return it;
        }
      }
    }
    return null;
  }

  async function handleAdd_(item){
    if (typeof item === "string"){
      const baseName = item;
      addLine_({ id: uid_(), baseName, displayName: baseName, qty: 1, note: "" });
      return;
    }

    if (item.type === "plain"){
      const baseName = item.name;
      const disp = `${item.name} (£${item.price.toFixed(2)})`;
      addLine_({ id: uid_(), baseName, displayName: disp, qty: 1, note: "" });
      return;
    }

    if (item.type === "wine"){
      const choice = await openModal_(`Select size — ${item.name}`, (root) => {
        const wrap = document.createElement("div");
        wrap.className = "btnGrid";
        let selected = item.sizes[0]?.label || "Bottle";
        item.sizes.forEach(s => {
          const b = document.createElement("button");
          b.type = "button";
          b.textContent = `${s.label} (£${Number(s.price).toFixed(2)})`;
          b.onclick = () => {
            selected = s.label;
            [...wrap.querySelectorAll("button")].forEach(x=>x.classList.remove("primary"));
            b.classList.add("primary");
          };
          if (s.label === selected) b.classList.add("primary");
          wrap.appendChild(b);
        });
        root.appendChild(wrap);
        return { get: ()=> selected };
      });
      if (!choice) return;
      const s = item.sizes.find(x=>x.label===choice) || item.sizes[0];
      const baseName = item.name;
      const disp = `${item.name} — ${s.label} (£${Number(s.price).toFixed(2)})`;
      addLine_({ id: uid_(), baseName, displayName: disp, qty: 1, note: "" });
      return;
    }

    if (item.type === "spirit"){
      const res = await openModal_(`Spirits — ${item.name}`, (root) => {
        const shotsField = document.createElement("div");
        shotsField.className = "field";
        shotsField.innerHTML = `<label>Shots (default 1)</label>`;
        const shotsSel = document.createElement("select");
        [1,2,3,4].forEach(n=>{
          const o = document.createElement("option");
          o.value = String(n);
          o.textContent = `${n} shot${n>1?"s":""}`;
          shotsSel.appendChild(o);
        });
        shotsSel.value = "1";
        shotsField.appendChild(shotsSel);

        const mixerField = document.createElement("div");
        mixerField.className = "field";
        mixerField.innerHTML = `<label>Mixer (+£1) — optional</label>`;
        const mixerSel = document.createElement("select");
        const none = document.createElement("option");
        none.value = "";
        none.textContent = "No mixer";
        mixerSel.appendChild(none);
        MIXER_CHOICES.forEach(m=>{
          const o = document.createElement("option");
          o.value = m;
          o.textContent = m;
          mixerSel.appendChild(o);
        });
        mixerField.appendChild(mixerSel);

        root.appendChild(shotsField);
        root.appendChild(mixerField);

        return { get: ()=>({ shots:Number(shotsSel.value||"1")||1, mixer:mixerSel.value||"" }) };
      });
      if (!res) return;

      const shots = Math.max(1, Math.min(6, Number(res.shots)||1));
      const mixer = res.mixer || "";

      // spirits: remove price display
      const baseName = item.name;
      const shotText = `${shots} shot${shots>1?"s":""}`;
      const disp = `${item.name} - ${shotText}${mixer ? " + " + mixer : ""}`;
      addLine_({ id: uid_(), baseName, displayName: disp, qty: 1, note: "" });
      return;
    }
  }

  function renderItems(){
    itemsWrap.innerHTML = "";

    const q = String(state.search || "").trim().toLowerCase();
    const usingSearch = q.length > 0;

    const title = document.createElement('div');
    title.className = "cat";
    title.textContent = usingSearch ? `Search results: "${state.search}"` : state.cat;
    itemsWrap.appendChild(title);

    const g=document.createElement('div');
    g.className="grid";

    let list = [];

    if (!usingSearch){
      list = MENU[state.cat] || [];
    } else {
      const out = [];
      for (const cat of Object.keys(MENU)){
        const arr = MENU[cat] || [];
        for (const it of arr){
          const name = (typeof it === "string") ? it : it.name;
          if (String(name).toLowerCase().includes(q)) out.push(it);
        }
      }
      const seen = new Set();
      list = out.filter(it => {
        const name = (typeof it === "string") ? it : it.name;
        if (seen.has(name)) return false;
        seen.add(name);
        return true;
      }).slice(0, 40);
    }

    if (!list.length){
      const empty = document.createElement("div");
      empty.className = "item";
      empty.textContent = "(No items)";
      g.appendChild(empty);
      itemsWrap.appendChild(g);
      return;
    }

    list.forEach(item=>{
      const baseName = (typeof item === "string") ? item : item.name;
      const count = countBase_(baseName);

      const d=document.createElement('div');
      d.className="item";

      const left=document.createElement('div');
      left.className="name";

      const right=document.createElement('div');
      right.className="qty";

      const nameBtn = document.createElement('button');
      nameBtn.type="button";
      nameBtn.className="nameBtn";
      nameBtn.textContent = (typeof item === "string") ? item : item.name;
      nameBtn.onclick = ()=>handleAdd_(item);
      left.appendChild(nameBtn);

      if (count > 0){
        const minus=document.createElement('button');
        minus.type="button";
        minus.textContent="−";
        minus.onclick=()=>removeOne_(baseName);

        const mid=document.createElement('span');
        mid.textContent = count;

        const plus=document.createElement('button');
        plus.type="button";
        plus.textContent="+";
        plus.onclick=()=>handleAdd_(item);

        right.append(minus, mid, plus);
      } else {
        right.style.display = "none";
      }

      d.append(left, right);
      g.appendChild(d);
    });

    itemsWrap.appendChild(g);
  }

  function buildOverviewText(){
    const lines = [];
    lines.push(`TABLE: ${state.table}`);
    lines.push(`TOTAL: ${totalQty_()}`);
    lines.push(`TIME: ${new Date().toLocaleString()}`);
    lines.push("");
    if (!state.cartLines.length){
      lines.push("(No items selected)");
    } else {
      state.cartLines.forEach(l=>{
        lines.push(`${l.qty} x ${l.displayName}`);
        const n = (l.note||"").trim();
        if (n) lines.push(`  - NOTE: ${n}`);
      });
    }
    return lines.join("\n");
  }

  function scrollCartToBottom_(){
    try{ cartListWrap.scrollTop = cartListWrap.scrollHeight; }catch{}
  }

  function renderCart(){
    totalQtyEl.textContent = totalQty_();
    cartLinesEl.innerHTML = "";

    state.cartLines.forEach((l, idx) => {
      const wrap = document.createElement("div");
      wrap.className = "cartLine";

      const top = document.createElement("div");
      top.className = "cartLineTop";
      const left = document.createElement("div");
      left.innerHTML = `<div class="cartLineName">${escapeHtml(l.displayName)}</div>`;

      const btns = document.createElement("div");
      btns.className = "cartLineBtns";

      const minus = document.createElement("button");
      minus.type="button"; minus.textContent="−";
      minus.onclick=()=>{
        if (l.qty > 1) l.qty -= 1;
        else state.cartLines.splice(idx,1);
        renderAll();
      };

      const mid = document.createElement("span");
      mid.style.minWidth="26px";
      mid.style.textAlign="center";
      mid.style.fontWeight="700";
      mid.textContent = l.qty;

      const plus = document.createElement("button");
      plus.type="button"; plus.textContent="+";
      plus.onclick=()=>{
        const itemObj = findItemByName_(l.baseName);
        if (itemObj) {
          handleAdd_(itemObj);
        } else {
          l.qty += 1;
          renderAll();
          setTimeout(scrollCartToBottom_, 0);
        }
      };

      const del = document.createElement("button");
      del.type="button"; del.textContent="×";
      del.onclick=()=>{ state.cartLines.splice(idx,1); renderAll(); };

      btns.append(minus, mid, plus, del);
      top.append(left, btns);

      const noteBox = document.createElement("div");
      noteBox.className = "noteBox";
      const ta = document.createElement("textarea");
      ta.rows = 2;
      ta.placeholder = "Item note (e.g. no spicy, allergy, less salt...)";
      ta.value = l.note || "";
      ta.oninput = ()=>{ l.note = ta.value; renderOverview(); };
      noteBox.appendChild(ta);

      wrap.append(top, noteBox);
      cartLinesEl.appendChild(wrap);
    });
  }

  function renderOverview(){ overviewBox.textContent = buildOverviewText(); }
  function renderAll(){ renderItems(); renderCart(); renderOverview(); }

  // cart expand/collapse (icons only)
  function setCartExpanded_(on){
    state.cartExpanded = !!on;
    cartListWrap.classList.toggle("expanded", state.cartExpanded);

    const downChevron = `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 9.5l8 8 8-8" fill="none" stroke="currentColor"
          stroke-width="3.2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`;
    const upChevron = `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 14.5l8-8 8 8" fill="none" stroke="currentColor"
          stroke-width="3.2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`;

    expandBtn.innerHTML = state.cartExpanded ? upChevron : downChevron;
    expandBtn.setAttribute("aria-label", state.cartExpanded ? "Collapse cart" : "Expand cart");
  }
  expandBtn.onclick = ()=>setCartExpanded_(!state.cartExpanded);

  document.getElementById('copyBtn').onclick = async () => {
    const text = buildOverviewText();
    try {
      await navigator.clipboard.writeText(text);
      statusEl.textContent = "Overview copied.";
      statusEl.className = "ok";
      setTimeout(()=>{statusEl.textContent=""; statusEl.className="danger";}, 1000);
    } catch {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      statusEl.textContent = "Overview copied.";
      statusEl.className = "ok";
      setTimeout(()=>{statusEl.textContent=""; statusEl.className="danger";}, 1000);
    }
  };

  document.getElementById('fullscreenBtn').onclick = () => {
    const wrap = overviewBox.parentElement;
    if (!document.fullscreenElement) wrap.requestFullscreen?.();
    else document.exitFullscreen?.();
  };

  // Send order (FULLSCREEN loading + success/fail)
  document.getElementById('submitBtn').onclick=async()=>{
    statusEl.className="danger";
    if(!state.cartLines.length){ statusEl.textContent="No items selected."; return; }
    if(!mustHaveUrl_()){ statusEl.textContent="SCRIPT_URL is not set."; return; }

    showSendOverlay_("Sending…", "Please wait.", false);

    const items = state.cartLines.map(l => ({
      name: l.displayName,
      qty: l.qty,
      note: (l.note || "").trim()
    }));

    const payload = { action:"create", table: state.table, items, note:"" };

    try{
      const r = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{"Content-Type":"text/plain;charset=utf-8"},
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if(!j.ok) throw new Error(j.error || "Unknown error");

      state.cartLines = [];
      renderAll();

      showSendOverlay_("Success", "Order sent.", true);

      // background update
      fetchOrders();
    }catch(e){
      showSendOverlay_("Failed", "Send failed. Use Overview to copy/screenshot and send downstairs.", true);
    }
  };

  // Ordered tabs (New/Keyed In) — immediate feedback then update
  function setOrderedTab_(t){
  state.orderedTab = t;
  tabNewBtn.classList.toggle("active", t==="NEW");
  tabKeyedBtn.classList.toggle("active", t==="KEYED_IN");

  liveStatus.textContent = "Refreshing…";
  fetchOrders({ force:true }); // 只有切 tab 先 force
}

  tabNewBtn.onclick = ()=>setOrderedTab_("NEW");
  tabKeyedBtn.onclick = ()=>setOrderedTab_("KEYED_IN");

  function parseItems(itemsJson){
    try{
      const arr = JSON.parse(itemsJson || "[]");
      if (!Array.isArray(arr)) return [];
      return arr
        .filter(x => x && x.name && x.qty)
        .map(x => ({name:String(x.name), qty:Number(x.qty)||0, note:String(x.note||"")}))
        .filter(x => x.qty > 0);
    }catch{ return []; }
  }

  function fmtTime(ts){
    try{
      const d = new Date(ts);
      if (isNaN(d.getTime())) return String(ts);
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }catch{ return String(ts); }
  }

  async function setStatus(orderId, status){
    if(!mustHaveUrl_()) return false;
    const payload = { action:"set_status", orderId, status };
    const r = await fetch(SCRIPT_URL, {
      method:"POST",
      headers:{"Content-Type":"text/plain;charset=utf-8"},
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || "set_status failed");
    return true;
  }

  async function deleteOrder_(orderId){
    if(!mustHaveUrl_()) return false;
    const payload = { action:"delete", orderId };
    const r = await fetch(SCRIPT_URL, {
      method:"POST",
      headers:{"Content-Type":"text/plain;charset=utf-8"},
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || "delete failed");
    return true;
  }

  function loadOrderIntoCart_(order){
    const items = parseItems(order.itemsJson);
    state.table = String(order.table || state.table);
    tableSel.value = state.table;

    state.cartLines = items.map(it => ({
      id: uid_(),
      baseName: (it.name || "").split(" - ")[0],
      displayName: String(it.name || ""),
      qty: Number(it.qty||0) || 1,
      note: String(it.note||"")
    })).filter(x => x.qty > 0);

    statusEl.textContent = "";
    statusEl.className = "danger";
    setPage_("ORDER");
    renderAll();
    setTimeout(scrollCartToBottom_, 0);
  }

  function renderOrders(orders){
    ordersWrap.innerHTML = "";
    if (!orders.length){
      ordersWrap.innerHTML = `<div class="ticket">(No orders)</div>`;
      return;
    }

    orders.forEach(o=>{
      const items = parseItems(o.itemsJson);
      const sep = "\n──────────────\n";
      const lines = items.map(it => {
        const base = `${it.qty} x ${it.name}`;
        const n = (it.note || "").trim();
        return n ? `${base}\n  - NOTE: ${n}` : base;
      }).join(sep) || "(No items)";

      const div = document.createElement("div");
      div.className = "ticket";

      const isNew = (o.status === "NEW");
      const primaryBtn = isNew
        ? `<button data-id="${o.orderId}" data-next="KEYED_IN">Keyed In</button>`
        : `<button data-id="${o.orderId}" data-next="NEW">Move back to New</button>`;

      div.innerHTML = `
        <div class="top">
          <b>${escapeHtml(o.table || "-")}</b>
          <span class="muted">${escapeHtml(fmtTime(o.ts))}</span>
        </div>
        <pre>${escapeHtml(lines)}</pre>
        <div class="actions">
          ${primaryBtn}
        </div>

        <button class="kebabBtn" type="button" aria-label="Edit menu">
          <div class="kebabDots"><span></span><span></span><span></span></div>
        </button>
        <div class="kebabMenu">
          <button type="button" data-act="edit">Edit (return to Order)</button>
          <button type="button" class="dangerBtn" data-act="delete">Delete</button>
        </div>
      `;

      const btn = div.querySelector("button[data-id]");
      btn.onclick = async () => {
        try{
          btn.disabled = true;
          await setStatus(btn.dataset.id, btn.dataset.next);
          fetchOrders();
        }catch(e){
          btn.disabled = false;
          alert("Status update failed: " + (e.message || e));
        }
      };

      const kebabBtn = div.querySelector(".kebabBtn");
      const menu = div.querySelector(".kebabMenu");
      const orderObj = { ...o };

      kebabBtn.onclick = (ev)=>{
        ev.stopPropagation();
        [...document.querySelectorAll(".kebabMenu")].forEach(x=>{ if(x!==menu) x.style.display="none"; });
        menu.style.display = (menu.style.display === "block") ? "none" : "block";
      };

      menu.querySelector('button[data-act="edit"]').onclick = ()=>{
        menu.style.display="none";
        loadOrderIntoCart_(orderObj);
      };

      menu.querySelector('button[data-act="delete"]').onclick = async ()=>{
        menu.style.display="none";
        if (!confirm("Delete this order?")) return;
        try{
          await deleteOrder_(String(o.orderId||""));
          fetchOrders();
        }catch(e){
          alert("Delete failed (backend action 'delete' not installed): " + (e.message || e));
        }
      };

      div.addEventListener("click", ()=>{ menu.style.display="none"; });

      ordersWrap.appendChild(div);
    });
  }

  // stable "instant" refresh: abort previous + ignore stale
  let fetching = false;
let fetchCtrl = null;
let fetchSeq = 0;

async function fetchOrders(opts){
  const o = opts || {};
  const force = !!o.force;

  if(!mustHaveUrl_()){
    liveStatus.textContent = "SCRIPT_URL not set.";
    return;
  }

  // Auto-refresh: 如果仲 fetch 緊就 skip，唔好 abort（避免永遠 loading）
  if (fetching && !force) return;

  // Force refresh（切頁/切tab/手動refresh）先 abort 舊 request
  if (force && fetching){
    try { fetchCtrl?.abort(); } catch {}
  }

  fetchCtrl = new AbortController();
  const mySeq = ++fetchSeq;
  fetching = true;

  try{
    const url = `${SCRIPT_URL}?status=${encodeURIComponent(state.orderedTab)}&t=${Date.now()}`;
    const r = await fetch(url, {
      method:"GET",
      cache:"no-store",
      signal: fetchCtrl.signal
    });

    const j = await r.json();

    // 如果係舊 request（被新一次 refresh 取代），直接唔處理
    if (mySeq !== fetchSeq) return;

    if(!j.ok) throw new Error(j.error || "GET failed");

    renderOrders(Array.isArray(j.orders) ? j.orders : []);
    liveStatus.textContent = `Updated: ${new Date().toLocaleTimeString()}`;

  }catch(e){
    // abort 係正常情況（force refresh）
    if (e && e.name === "AbortError") return;
    if (mySeq !== fetchSeq) return;
    liveStatus.textContent = "Refresh failed (check Apps Script deployment).";
  }finally{
    // 只清除「最新嗰次」嘅 fetching 狀態
    if (mySeq === fetchSeq) fetching = false;
  }
}

  document.getElementById('refreshBtn').onclick = ()=>fetchOrders({ force:true });

  // auto refresh interval => 1 second (only on Ordered page)
 setInterval(()=>{
  if (state.page === "ORDERED") fetchOrders({ force:false });
}, 1000);

  // End of day: clear all
  document.getElementById('clearAllBtn').onclick = async () => {
    if(!mustHaveUrl_()){ alert("SCRIPT_URL not set."); return; }
    const key = prompt("Enter end-of-day clear key:");
    if (!key) return;

    if (!confirm("This will delete ALL orders (NEW and KEYED IN). Continue?")) return;

    try{
      const payload = { action:"clear_all", key };
      const r = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{"Content-Type":"text/plain;charset=utf-8"},
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if(!j.ok) throw new Error(j.error || "clear_all failed");
      fetchOrders();
      alert("All records cleared.");
    }catch(e){
      alert("Clear failed: " + (e.message || e));
    }
  };

  // Initial
  setCartExpanded_(false);
  renderAll();
  fetchOrders();

  // Block double-tap zoom (iOS Safari)
  let lastTouchEnd = 0;
  document.addEventListener('gesturestart', function (e) {
  e.preventDefault();
});

  // Block pinch zoom (iOS Safari)
  document.addEventListener('gesturestart', function (e) { e.preventDefault(); });
  document.addEventListener('gesturechange', function (e) { e.preventDefault(); });
  document.addEventListener('gestureend', function (e) { e.preventDefault(); });
</script>
</body>
</html>






